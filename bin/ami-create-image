#!/usr/bin/env python

def get_args():
    import argparse
    parser = argparse.ArgumentParser(description='ami-create-image - Like ec2-create-image, but way better')
    parser.add_argument('instance_id',
                        help='Instance ID to create image from')
    parser.add_argument('-r', '--region',
                        help='''Specify REGION as the web service region to use.
Overrides the value specified by AWS_DEFAULT_REGION.
''')
    parser.add_argument('-n', '--name', default=None,
                        help='Name of the image')
    parser.add_argument('-N', '--random-name', default=None,
                        help='Prefix for random name of an image')
    parser.add_argument('-d', '--description', default=None,
                        help='Description of the image')
    parser.add_argument('--no-reboot', default=False, action='store_true',
                        help='If specified, the instance will not be rebooted during the bundle process.')
    parser.add_argument('-b', '--block-device-mapping', default=None,
                        help='')
    args = parser.parse_args()
    assert args.block_device_mapping is None, "Don't support block device mappings yet"
    return args

def ec2connect():
    import os
    from boto.ec2 import connect_to_region
    access_key = os.environ['AWS_ACCESS_KEY_ID']
    secret_key = os.environ['AWS_SECRET_ACCESS_KEY']
    region = os.environ['AWS_DEFAULT_REGION']
    return connect_to_region(region, aws_access_key_id=access_key, aws_secret_access_key=secret_key)

if '__main__' == __name__:
    args = get_args()
    import datetime
    import time
    from amitools import (
        EC2ImageWatcher,
        get_instance,
        random_name,
        )

    if args.name is None:
        args.name = random_name(args.random_name)
    if args.description is not None:
        params['description'] = args.description
    if args.no_reboot:
        params['NoReboot'] = True

    conn = ec2connect()
    image_id = conn.create_image(
        args.instance_id,
        args.name,
        description=args.description,
        no_reboot = args.no_reboot,
        )
    image_watcher = EC2ImageWatcher(image_id, conn)
    image_watcher.waiton_exists()
    # AMI image creation started. While that's cooking, set up tags
    image = image_watcher.resource
    source_instance = get_instance(conn, args.instance_id)
    tags = {
        'source_image'     : source_instance.image_id,
        'source_instance'  : args.instance_id,
        'create_date'      : datetime.datetime.now(),
        'create_timestamp' : int(time.time()),
        }
    conn.create_tags([image_id], tags)
    # Done, now report the image
    print('\t'.join([
            'IMAGE',
            image_id,
            ]))
